import readline from "node:readline/promises";

const instructions = {
  ">": "movr",
  "<": "movl",
  ".": "out",
  ",": "in",
  "+": "inc",
  "-": "dec",
  "[": "jz",
  "]": "jnz",
};

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout,
  prompt: ">",
});

export const bf = async (_program: string) => {
  const np = _program
    .split("")
    .filter((c) => Object.keys(instructions).includes(c));
  let ap = 0;
  let pc = 0;
  const memory = new Uint8Array(9999999);

  const incAp = () => {
    if (ap === memory.length - 1) {
      ap = 0;
      return;
    }
    ap++;
  };

  const decAp = () => {
    if (ap === 0) {
      ap = memory.length - 1;
      return;
    }
    ap--;
  };

  let output = "";
  let input: string[] = [];

  if (np.includes(",")) {
    const response = await rl.question("");
    rl.close();
    input = response.split("");
    console.log(input);
  }

  let bStack = 0;
  for (pc; pc < np.length; pc++) {
    const p = np[pc];
    switch (p) {
      case ".":
        output += String.fromCharCode(memory[ap]);
        continue;
      case ",":
        const a = input.shift()?.charCodeAt(0) || 0;
        memory[ap] = a;
        continue;
      case "-":
        memory[ap]--;
        continue;
      case "+":
        memory[ap]++;
        continue;
      case ">":
        incAp();
        continue;
      case "<":
        decAp();
        continue;
      case "[": {
        if (memory[ap] !== 0) {
          continue;
        }
        bStack++;

        while (np[pc] !== "]" || bStack !== 0) {
          pc++;

          if (np[pc] === "[") {
            bStack++;
          } else if (np[pc] === "]") {
            bStack--;
          }
        }

        continue;
      }
      case "]": {
        if (memory[ap] === 0) {
          continue;
        }
        bStack++;

        while (np[pc] !== "[" || bStack != 0) {
          pc--;

          if (np[pc] === "]") {
            bStack++;
          } else if (np[pc] === "[") {
            bStack--;
          }
        }
      }
    }
  }
  console.log(output);

  return { memory, ap, pc, output };
};

// 99 bottles
// bf(`>++++++++++[<++++++++++>-]<->>>>>+++[>+++>+++<<-]<<<<+<[>[>+
// >+<<-]>>[-<<+>>]++++>+<[-<->]<[[-]>>-<<]>>[[-]<<+>>]<<[[-]>>
// >>>>[[-]<++++++++++<->>]<-[>+>+<<-]>[<+>-]+>[[-]<->]<<<<<<<<
// <->>]<[>+>+<<-]>>[-<<+>>]+>+<[-<->]<[[-]>>-<<]>>[[-]<<+>>]<<
// <[>>+>+<<<-]>>>[-<<<+>>>]++>+<[-<->]<[[-]>>-<<]>>[[-]<<+>>]<
// <[>+<[-]]<[>>+<<[-]]>>[<<+>>[-]]<<<[>>+>+<<<-]>>>[-<<<+>>>]+
// +++>+<[-<->]<[[-]>>-<<]>>[[-]<<+>>]<<[>+<[-]]<[>>+<<[-]]>>[<
// <+>>[-]]<<[[-]>>>++++++++[>>++++++<<-]>[<++++++++[>++++++<-]
// >.<++++++++[>------<-]>[<<+>>-]]>.<<++++++++[>>------<<-]<[-
// >>+<<]<++++++++[<++++>-]<.>+++++++[>+++++++++<-]>+++.<+++++[
// >+++++++++<-]>.+++++..--------.-------.++++++++++++++>>[>>>+
// >+<<<<-]>>>>[-<<<<+>>>>]>+<[-<->]<[[-]>>-<<]>>[[-]<<+>>]<<<<
// [>>>+>+<<<<-]>>>>[-<<<<+>>>>]+>+<[-<->]<[[-]>>-<<]>>[[-]<<+>
// >]<<<[>>+<<[-]]>[>+<[-]]++>>+<[-<->]<[[-]>>-<<]>>[[-]<<+>>]<
// +<[[-]>-<]>[<<<<<<<.>>>>>>>[-]]<<<<<<<<<.>>----.---------.<<
// .>>----.+++..+++++++++++++.[-]<<[-]]<[>+>+<<-]>>[-<<+>>]+>+<
// [-<->]<[[-]>>-<<]>>[[-]<<+>>]<<<[>>+>+<<<-]>>>[-<<<+>>>]++++
// >+<[-<->]<[[-]>>-<<]>>[[-]<<+>>]<<[>+<[-]]<[>>+<<[-]]>>[<<+>
// >[-]]<<[[-]>++++++++[<++++>-]<.>++++++++++[>+++++++++++<-]>+
// .-.<<.>>++++++.------------.---.<<.>++++++[>+++<-]>.<++++++[
// >----<-]>++.+++++++++++..[-]<<[-]++++++++++.[-]]<[>+>+<<-]>>
// [-<<+>>]+++>+<[-<->]<[[-]>>-<<]>>[[-]<<+>>]<<[[-]++++++++++.
// >+++++++++[>+++++++++<-]>+++.+++++++++++++.++++++++++.------
// .<++++++++[>>++++<<-]>>.<++++++++++.-.---------.>.<-.+++++++
// ++++.++++++++.---------.>.<-------------.+++++++++++++.-----
// -----.>.<++++++++++++.---------------.<+++[>++++++<-]>..>.<-
// ---------.+++++++++++.>.<<+++[>------<-]>-.+++++++++++++++++
// .---.++++++.-------.----------.[-]>[-]<<<.[-]]<[>+>+<<-]>>[-
// <<+>>]++++>+<[-<->]<[[-]>>-<<]>>[[-]<<+>>]<<[[-]++++++++++.[
// -]<[-]>]<+<]`);

// calc
bf(`
[
Does any opertion with any two numbers
Examples:
134+55=
78-47=
13*14=
64/8=
45%3=
6^3=
Always remember to put an equal sign on the end

Code by Antosser. Compiled using https://github.com/Antosser/brainfuck-compiler
5470 characters
]

>>>>>>>>>>+@<<<<<<<<<++++[->>>>>>>>>>>>++++++++<<<<<<<<<<<<]>>>>>>>>>>>>>++++++++++@<<<<<<<<<<<<<+++
++++++++[>>>>>>>>>>>>>>++++++<<<<<<<<<<<<<<-]>>>>>>>>>>>>>>.<<<<<<<<<<<<<<++++++++[>>>>>>>>>>>>>>+++
+++<<<<<<<<<<<<<<-]>>>>>>>>>>>>>>.<<<<<<<<<<<<<<++++[>>>>>>>>>>>>>>----<<<<<<<<<<<<<<-]>>>>>>>>>>>>>
>-.++++++++.+++++.--------.<<<<<<<<<<<<<<+++++[>>>>>>>>>>>>>>+++<<<<<<<<<<<<<<-]>>>>>>>>>>>>>>.<<<<<
<<<<<<<<<++++++[>>>>>>>>>>>>>>---<<<<<<<<<<<<<<-]>>>>>>>>>>>>>>.++++++++.<<<<<<<<<<<<<<+++++++[>>>>>
>>>>>>>>>-----------<<<<<<<<<<<<<<-]>>>>>>>>>>>>>>++.<<<<<<<<<<<<<<+++++++[>>>>>>>>>>>>>>+++++<<<<<<
<<<<<<<<-]>>>>>>>>>>>>>>.<<<<<<<<<<<<<<++++++[>>>>>>>>>>>>>>+++++<<<<<<<<<<<<<<-]>>>>>>>>>>>>>>.++++
+++++++.---------.<<<<<<<<<<<<<<++++++[>>>>>>>>>>>>>>+++<<<<<<<<<<<<<<-]>>>>>>>>>>>>>>.---------.---
--------.<<<<<<<<<<<<<<++++[>>>>>>>>>>>>>>+++++<<<<<<<<<<<<<<-]>>>>>>>>>>>>>>-.-----.+++.<<<<<<<<<<<
<<<+++++++++[>>>>>>>>>>>>>>---------<<<<<<<<<<<<<<-]>>>>>>>>>>>>>>-.<<<<<<<<<<<<<<+++++++[>>>>>>>>>>
>>>>---<<<<<<<<<<<<<<-]>>>>>>>>>>>>>>-.[-]@<<<<<<+[>>>>>>>,[<<<<<<<<<<<<<<<+<+>>>>>>>>>>>>>>>>-]<<<<
<<<<<<<<<<<[>>>>>>>>>>>>>>>+<<<<<<<<<<<<<<<-]++++++++[<---->-]<[>+<-]+>[<->[-]]<[[-]>-<]>+[->>>>>>>>
>>>>>>>[<<<<<<<<<<<<<<<+<+>>>>>>>>>>>>>>>>-]<<<<<<<<<<<<<<<[>>>>>>>>>>>>>>>+<<<<<<<<<<<<<<<-]+++++++
++++[<--------->-]<[>+<-]+>[<->[-]]<[[-]>>>>>>>>>>>>>>>++++++++++.[-]++++++++++.[-]<..<<<<<->-<<<<<<
<<<-<]>+[->>>>>>>>>>>>>>>[<<<<<<<<<<<<<<<+<+>>>>>>>>>>>>>>>>-]<<<<<<<<<<<<<<<[>>>>>>>>>>>>>>>+<<<<<<
<<<<<<<<<-]++++++++++[<------>-]-<[>+<-]+>[<->[-]]<[[-]>>>>>>>>>-<<<<<<<<-<]>+[->>>>>>>>>>>>>>>[<<<<
<<<<<<<<<<<+<+>>>>>>>>>>>>>>>>-]<<<<<<<<<<<<<<<[>>>>>>>>>>>>>>>+<<<<<<<<<<<<<<<-]+++++++[<------>-]-
<[>+<-]+>[<->[-]]<[[-]>>>>>>>>>>>>>>>>[<<<<<<<<<<<<+>>>>>>>>>>>>-]<<<<+<<<<<<<<<<<-<]>+[->>>>>>>>>>>
>>>>[<<<<<<<<<<<<<<<+<+>>>>>>>>>>>>>>>>-]<<<<<<<<<<<<<<<[>>>>>>>>>>>>>>>+<<<<<<<<<<<<<<<-]+++++++++[
<----->-]<[>+<-]+>[<->[-]]<[[-]>>>>>>>>>>>>>>>>[<<<<<<<<<<<<+>>>>>>>>>>>>-]<<<<+<<<<<<<<<<<-<]>+[->>
>>>>>>>>>>>>>[<<<<<<<<<<<<<<<+<+>>>>>>>>>>>>>>>>-]<<<<<<<<<<<<<<<[>>>>>>>>>>>>>>>+<<<<<<<<<<<<<<<-]+
++++++[<------>-]<[>+<-]+>[<->[-]]<[[-]>>>>>>>>>>>>>>>>[<<<<<<<<<<<<+>>>>>>>>>>>>-]<<<<+<<<<<<<<<<<-
<]>+[->>>>>>>>>>>>>>>[<<<<<<<<<<<<<<<+<+>>>>>>>>>>>>>>>>-]<<<<<<<<<<<<<<<[>>>>>>>>>>>>>>>+<<<<<<<<<<
<<<<<-]++++++[<-------->-]+<[>+<-]+>[<->[-]]<[[-]>>>>>>>>>>>>>>>>[<<<<<<<<<<<<+>>>>>>>>>>>>-]<<<<+<<
<<<<<<<<<-<]>+[->>>>>>>>>>>>>>>[<<<<<<<<<<<<<<<+<+>>>>>>>>>>>>>>>>-]<<<<<<<<<<<<<<<[>>>>>>>>>>>>>>>+
<<<<<<<<<<<<<<<-]++++++[<------>-]-<[>+<-]+>[<->[-]]<[[-]>>>>>>>>>>>>>>>>[<<<<<<<<<<<<+>>>>>>>>>>>>-
]<<<<+<<<<<<<<<<<-<]>+[->>>>>>>>>>>>>>>[<<<<<<<<<<<<<<<+<+>>>>>>>>>>>>>>>>-]<<<<<<<<<<<<<<<[>>>>>>>>
>>>>>>>+<<<<<<<<<<<<<<<-]++++++++[<------------>-]++<[>+<-]+>[<->[-]]<[[-]>>>>>>>>>>>>>>>>[<<<<<<<<<
<<<+>>>>>>>>>>>>-]<<<<+<<<<<<<<<<<-<]>+[-++++++++[->>>>>>>>>>>>>>>------<<<<<<<<<<<<<<<]>>>>>>>>>>>[
<<<<<<<<<<<+<+>>>>>>>>>>>>-]<<<<<<<<<<<[>>>>>>>>>>>+<<<<<<<<<<<-]+[<->-]+<[>+<-]+>[<->[-]]<[[-]>>[<+
>-]<[>++++++++++<-]>>>>>>>>>>>>>>>[<<<<<<<<<<<<<<+>>>>>>>>>>>>>>-]<<<<<<<<<<<<<<<-<]>+[->>>>>>>>>>>[
<<<<<<<<<<<+<+>>>>>>>>>>>>-]<<<<<<<<<<<[>>>>>>>>>>>+<<<<<<<<<<<-]+[<->-]<[>+<-]+>[<->[-]]<[[-]>>>[<<
+>>-]<<[>>++++++++++<<-]>>>>>>>>>>>>>>>[<<<<<<<<<<<<<+>>>>>>>>>>>>>-]<<<<<<<<<<<<<<<-<]>+[->>>>>>>>>
>>>>>++++++++++.[-]<<<<<+<<<<<<<<<]]]]]]]]]]]>>>>>>>>]@<<<<<[<<<+<+>>>>-]<<<[>>>+<<<-]+++++++[<-----
->-]-<[>+<-]+>[<->[-]]<[[-]>>[>>>>>>>>>+<<<<<<<<<-]>[>>>>>>>>+<<<<<<<<-]<<<]>>>>[<<<+<+>>>>-]<<<[>>>
+<<<-]+++++++[<------>-]<[>+<-]+>[<->[-]]<[[-]>>[->[<<+>>>>>>>>>>+<<<<<<<<-]<<[>>+<<-]>]<<]>>>>[<<<+
<+>>>>-]<<<[>>>+<<<-]+++++++++[<----->-]<[>+<-]+>[<->[-]]<[[-]>>[>>>>>>>>>+<<<<<<<<<-]>[->>>>>>>>-<<
<<<<<<]<<<]>>>>[<<<+<+>>>>-]<<<[>>>+<<<-]++++++[<-------->-]+<[>+<-]+>[<->[-]]<[[-]>>>[<<+>>>>>>>>+<
<<<<<-]<<[>>+<<-]>[->>>>>>>-[<<<<<<<<+<+>>>>>>>>>-]<<<<<<<<[>>>>>>>>+<<<<<<<<-]<[[-]>-<]>+[-<+>]<[[-
]>>>[<<+>>>>>>>>+<<<<<<-]<<[>>+<<-]>>>>>>>>>>+<<<<<<<<<<<]>>]<<]>>>>[<<<+<+>>>>-]<<<[>>>+<<<-]++++++
[<------>-]-<[>+<-]+>[<->[-]]<[[-]>>>[<<+>>>>>>>>+<<<<<<-]<<[>>+<<-]>[->>>>>>>-[<<<<<<<<+<+>>>>>>>>>
-]<<<<<<<<[>>>>>>>>+<<<<<<<<-]<[[-]>-<]>+[-<+>]<[[-]>>>[<<+>>>>>>>>+<<<<<<-]<<[>>+<<-]<]>>]>[>>>>>>>
>+<<<<<<<<-]>>>>>>[>>-<<-]<<<<<<<<<]>>>>[<<<+<+>>>>-]<<<[>>>+<<<-]++++++++[<------------>-]++<[>+<-]
+>[<->[-]]<[[-]>>>>>>>>>>>+<<<<<<<<[>>>>>>>>[<<<<<<<<<[<+<+>>-]<[>+<-]>>>>>>>>>>-]<<<<<<<<<<<[>>>>>>
>>>>>+<<<<<<<<<<<-]>>>-]<<<]>>>>>>>>>>[<<<<<<<<<+<+>>>>>>>>>>-]<<<<<<<<<[>>>>>>>>>+<<<<<<<<<-]<[[-]>
>>>>>>>>>>>>.<<<<<<<++++++++++>>>>>[<<<<<<<<<<+>>>>>>>>>>>>>>>>+<<<<<<-]<<<<<<<<<<[>>>>>>>>>>+<<<<<<
<<<<-]>>>>>>>>>>>>>>>>[-<<<<<<<<<<<-[<<<<<+<+>>>>>>-]<<<<<[>>>>>+<<<<<-]<[[-]>-<]>+[->>>>>>+<+++++++
+++<<<<<]>>>>>>>>>>>>>>>>]<<<<<<<<<<<<<<<<++++++++++>>>>>[-<<<<<->>>>>]<<<<<[->>>>>+<<<<<]>>>>>>[->>
>>>>>>>>+<<<<<<<<<<]++++++++++>>>>>>>>>>[-<<<<<<<<<<-[<<<<<<+<+>>>>>>>-]<<<<<<[>>>>>>+<<<<<<-]<[[-]>
-<]>+[->>>>>>>+<++++++++++<<<<<<]>>>>>>>>>>>>>>>>]<<<<<<<<<<<<<<<<++++++++++>>>>>>[-<<<<<<->>>>>>]<<
<<<<[->>>>>>+<<<<<<]>>>>>>[<<<<<<+>>>>+>>-]<<<<<<[>>>>>>+<<<<<<-]>>>>>>>[<<<<<<<+>>>>+>>>-]<<<<<<<[>
>>>>>>+<<<<<<<-]>>>>>>>[<<<<<<<+<+>>>>>>>>-]<<<<<<<[>>>>>>>+<<<<<<<-]<[[-]>++++++++[->>>>>>>++++++<<
<<<<<]>>>>>>>.<<<<<<<<]>>>>>[<<<<+<+>>>>>-]<<<<[>>>>+<<<<-]<[[-]>++++++++[->>>>>>++++++<<<<<<]>>>>>>
.<<<<<<<]>++++++++[->>>>>++++++<<<<<]>>>>>.[-]>[-]>[-]<<<<<<<<]
`);
